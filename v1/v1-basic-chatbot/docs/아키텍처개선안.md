# 아키텍처 개선안: DB 중심 설계

## 현재 구조의 문제점

### 현재 방식 (JS 중심)
```
엑셀 파일 → JS 파싱 → Firestore (각 행을 문서로) → JS에서 필터링
```

**문제점:**
- ❌ 컬럼명 매핑이 복잡하고 부정확
- ❌ 모든 데이터를 메모리로 가져와야 함
- ❌ 복잡한 쿼리 불가능
- ❌ 성능 저하 (대용량 데이터)
- ❌ 컬럼 구조가 명확하지 않음

## 개선된 구조 (DB 중심)

### 새로운 방식
```
엑셀 파일 → 백엔드 파싱 → PostgreSQL 테이블 (컬럼별 저장) → SQL 쿼리
```

**장점:**
- ✅ 컬럼명이 실제 DB 컬럼으로 저장 (매핑 불필요)
- ✅ SQL로 정확한 필터링
- ✅ 필요한 데이터만 가져오기
- ✅ 복잡한 쿼리 가능
- ✅ 성능 향상
- ✅ 데이터 구조 명확

## 구현 방법

### 옵션 1: Supabase (추천)
- PostgreSQL 기반
- REST API 자동 생성
- 실시간 기능
- 클라이언트에서 직접 접근 가능

### 옵션 2: Node.js + PostgreSQL
- 완전한 제어
- 커스텀 API
- 더 많은 설정 필요

## 데이터 구조

### 테이블 설계

```sql
-- 업로드된 파일 정보
CREATE TABLE uploads (
    id SERIAL PRIMARY KEY,
    filename VARCHAR(255),
    uploaded_at TIMESTAMP DEFAULT NOW(),
    row_count INTEGER
);

-- 엑셀 데이터 (동적 컬럼)
-- 방법 1: JSONB 사용 (유연함)
CREATE TABLE excel_data (
    id SERIAL PRIMARY KEY,
    upload_id INTEGER REFERENCES uploads(id),
    row_index INTEGER,
    data JSONB,  -- 모든 컬럼을 JSON으로 저장
    created_at TIMESTAMP DEFAULT NOW()
);

-- 방법 2: 동적 테이블 생성 (컬럼명이 명확함)
-- 각 파일마다 별도 테이블 생성
-- 예: excel_data_20241201_123456
```

### 쿼리 예시

```sql
-- 경도 128.954044에서 pH 값 찾기
SELECT data->>'pH' as pH
FROM excel_data
WHERE (data->>'경도')::float = 128.954044;

-- 또는 동적 테이블인 경우
SELECT "pH"
FROM excel_data_20241201_123456
WHERE "경도" = 128.954044;
```

## 구현 단계

1. **백엔드 API 구축**
   - 파일 업로드 엔드포인트
   - 엑셀 파싱 및 DB 저장
   - 쿼리 엔드포인트

2. **DB 스키마 설계**
   - 테이블 구조 결정
   - 인덱스 생성

3. **프론트엔드 수정**
   - API 호출로 변경
   - 쿼리 결과 표시

## 추천 구조

**Supabase + 동적 테이블 생성**

1. 파일 업로드 시:
   - 엑셀 파싱
   - 컬럼명 추출
   - 동적 테이블 생성 (컬럼명이 실제 컬럼)
   - 데이터 삽입

2. 질문 시:
   - 자연어 → SQL 변환
   - SQL 쿼리 실행
   - 결과 반환

이렇게 하면 컬럼명 매핑 문제가 완전히 해결됩니다!

